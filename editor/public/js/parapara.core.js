var ParaPara=ParaPara||{};ParaPara.SVG_NS="http://www.w3.org/2000/svg";ParaPara.XLINK_NS="http://www.w3.org/1999/xlink";ParaPara.init=function(a){console.assert(!a.hasChildNodes(),"Content group should be empty");ParaPara.contentGroup=a;ParaPara.svgRoot=ParaPara.contentGroup.ownerSVGElement;ParaPara.editContent=document.createElementNS(ParaPara.SVG_NS,"g");ParaPara.contentGroup.appendChild(ParaPara.editContent);ParaPara.drawControls=new ParaPara.DrawControls();ParaPara.eraseControls=new ParaPara.EraseControls();ParaPara.frames=new ParaPara.FrameList();ParaPara.currentStyle=new ParaPara.Style();ParaPara.currentTool=null};ParaPara.reset=function(){while(ParaPara.contentGroup.hasChildNodes()){ParaPara.contentGroup.removeChild(ParaPara.contentGroup.lastChild)}ParaPara.init(ParaPara.contentGroup)};ParaPara.appendFrame=function(){var a=ParaPara.frames.appendFrame();ParaPara.currentTool.targetFrame(ParaPara.frames.getCurrentFrame());return a};ParaPara.selectFrame=function(b){var a=ParaPara.frames.selectFrame(b);ParaPara.currentTool.targetFrame(ParaPara.frames.getCurrentFrame());return a};ParaPara.deleteFrame=function(b){var a=ParaPara.frames.deleteFrame(b);ParaPara.currentTool.targetFrame(ParaPara.frames.getCurrentFrame());return a};ParaPara.getCurrentFrame=function(a){var b=ParaPara.frames.getCurrentFrame();var a=ParaPara.frames.getCurrentIndex();return{index:a,svg:b}};ParaPara.setDrawMode=function(){if(ParaPara.currentTool===ParaPara.drawControls){return false}if(ParaPara.currentTool){ParaPara.currentTool.disable()}ParaPara.drawControls.targetFrame(ParaPara.frames.getCurrentFrame());ParaPara.currentTool=ParaPara.drawControls;return true};ParaPara.setEraseMode=function(){if(ParaPara.currentTool===ParaPara.eraseControls){return false}if(ParaPara.currentTool){ParaPara.currentTool.disable()}ParaPara.eraseControls.targetFrame(ParaPara.frames.getCurrentFrame());ParaPara.currentTool=ParaPara.eraseControls;return true};ParaPara.animate=function(a){if(ParaPara.currentTool){ParaPara.currentTool.disable()}ParaPara.editContent.setAttribute("display","none");ParaPara.animator=new ParaPara.Animator(a,ParaPara.contentGroup);ParaPara.animator.makeAnimation();ParaPara.svgRoot.unpauseAnimations()};ParaPara.pauseAnimation=function(){if(ParaPara.animator){ParaPara.svgRoot.pauseAnimations()}};ParaPara.resumeAnimation=function(){if(ParaPara.animator){ParaPara.svgRoot.unpauseAnimations()}};ParaPara.removeAnimation=function(){if(ParaPara.animator){ParaPara.animator.removeAnimation();ParaPara.animator=null;ParaPara.svgRoot.unpauseAnimations()}ParaPara.editContent.removeAttribute("display");if(ParaPara.currentTool){ParaPara.currentTool.targetFrame(ParaPara.frames.getCurrentFrame())}};ParaPara.getMode=function(){if(ParaPara.currentTool===ParaPara.drawControls){return"draw"}if(ParaPara.currentTool===ParaPara.eraseControls){return"erase"}if(ParaPara.animator){return"animate"}return"draw"};ParaPara.send=function(h,a,g,b){console.assert(ParaPara.animator,"No animator found");var e=ParaPara.animator.exportAnimation(b.title,b.author);if(!e){g("no-animation");return}var f={metadata:b};var d=new XMLSerializer();var c=d.serializeToString(e.doc);f.svg=c;f.metadata.groundOffset=e.groundOffset;f.metadata.width=e.width;f.metadata.height=e.height;ParaPara.postRequest(h,f,a,g)};ParaPara.sendEmail=function(c,d,b,a,f){var e={address:c,locale:b};ParaPara.postRequest(d,e,a,f)};ParaPara.fixPrecision=function(a){return a.toFixed(2)};ParaPara.notifyGraphicChanged=function(){var a=document.createEvent("CustomEvent");a.initCustomEvent("changegraphic",true,true,{});ParaPara.svgRoot.dispatchEvent(a)};ParaPara.DrawControls=function(){this.linesInProgress=new Object;this.frame=null;this.mouseDownHandler=this.mouseDown.bind(this);this.mouseMoveHandler=this.mouseMove.bind(this);this.mouseUpHandler=this.mouseUp.bind(this);this.touchStartHandler=this.touchStart.bind(this);this.touchMoveHandler=this.touchMove.bind(this);this.touchEndHandler=this.touchEnd.bind(this);this.touchCancelHandler=this.touchCancel.bind(this)};ParaPara.DrawControls.prototype.targetFrame=function(a){this.frame=a;ParaPara.svgRoot.addEventListener("mousedown",this.mouseDownHandler,false);ParaPara.svgRoot.addEventListener("mousemove",this.mouseMoveHandler,false);ParaPara.svgRoot.addEventListener("mouseup",this.mouseUpHandler,false);ParaPara.svgRoot.addEventListener("touchstart",this.touchStartHandler,false);ParaPara.svgRoot.addEventListener("touchmove",this.touchMoveHandler,false);ParaPara.svgRoot.addEventListener("touchend",this.touchEndHandler,false);ParaPara.svgRoot.addEventListener("touchcancel",this.touchCancelHandler,false)};ParaPara.DrawControls.prototype.disable=function(){ParaPara.svgRoot.removeEventListener("mousedown",this.mouseDownHandler,false);ParaPara.svgRoot.removeEventListener("mousemove",this.mouseMoveHandler,false);ParaPara.svgRoot.removeEventListener("mouseup",this.mouseUpHandler,false);ParaPara.svgRoot.removeEventListener("touchstart",this.touchStartHandler,false);ParaPara.svgRoot.removeEventListener("touchmove",this.touchMoveHandler,false);ParaPara.svgRoot.removeEventListener("touchend",this.touchEndHandler,false);ParaPara.svgRoot.removeEventListener("touchcancel",this.touchCancelHandler,false)};ParaPara.DrawControls.prototype.mouseDown=function(a){a.preventDefault();if(a.button||this.linesInProgress.mouseLine){return}var b=this.getLocalCoords(a.clientX,a.clientY,this.frame);this.linesInProgress.mouseLine=new ParaPara.FreehandLine(b.x,b.y,this.frame)};ParaPara.DrawControls.prototype.mouseMove=function(a){a.preventDefault();if(!this.linesInProgress.mouseLine){return}var b=this.getLocalCoords(a.clientX,a.clientY,this.frame);this.linesInProgress.mouseLine.addPoint(b.x,b.y)};ParaPara.DrawControls.prototype.mouseUp=function(a){a.preventDefault();if(!this.linesInProgress.mouseLine){return}this.linesInProgress.mouseLine.finishLine();delete this.linesInProgress.mouseLine;ParaPara.notifyGraphicChanged()};ParaPara.DrawControls.prototype.touchStart=function(a){a.preventDefault();for(var b=0;b<a.changedTouches.length;++b){var d=a.changedTouches[b];var c=this.getLocalCoords(d.clientX,d.clientY,this.frame);this.linesInProgress[d.identifier]=new ParaPara.FreehandLine(c.x,c.y,this.frame)}};ParaPara.DrawControls.prototype.touchMove=function(a){a.preventDefault();for(var b=0;b<a.changedTouches.length;++b){var d=a.changedTouches[b];var c=this.getLocalCoords(d.clientX,d.clientY,this.frame);console.assert(this.linesInProgress[d.identifier],"Unexpected touch event");this.linesInProgress[d.identifier].addPoint(c.x,c.y)}};ParaPara.DrawControls.prototype.touchEnd=function(a){a.preventDefault();for(var b=0;b<a.changedTouches.length;++b){var c=a.changedTouches[b];console.assert(this.linesInProgress[c.identifier],"Unexpected touch event");this.linesInProgress[c.identifier].finishLine();delete this.linesInProgress[c.identifier]}ParaPara.notifyGraphicChanged()};ParaPara.DrawControls.prototype.touchCancel=function(a){a.preventDefault();for(var b=0;b<a.changedTouches.length;++b){var c=a.changedTouches[b];console.assert(this.linesInProgress[c.identifier],"Unexpected touch event");this.linesInProgress[c.identifier].cancelLine();delete this.linesInProgress[c.identifier]}};ParaPara.DrawControls.prototype.getLocalCoords=function(a,e,b){var d=ParaPara.svgRoot.createSVGPoint();d.x=a;d.y=e;var c=b.parentNode.getScreenCTM();return d.matrixTransform(c.inverse())};ParaPara.FreehandLine=function(a,d,c){this.polyline=document.createElementNS(ParaPara.SVG_NS,"polyline");ParaPara.currentStyle.styleStroke(this.polyline);c.appendChild(this.polyline);var b=ParaPara.svgRoot.createSVGPoint();b.x=a;b.y=d;this.polyline.points.appendItem(b)};ParaPara.FreehandLine.prototype.addPoint=function(a,c){console.assert(this.polyline,"Adding point to finished/cancelled line?");var b=ParaPara.svgRoot.createSVGPoint();b.x=a;b.y=c;this.polyline.points.appendItem(b)};ParaPara.FreehandLine.prototype.finishLine=function(){console.assert(this.polyline,"Line already finished/cancelled?");var a=this.createPathFromPoints(this.polyline.points);this.polyline.parentNode.appendChild(a);this.polyline.parentNode.removeChild(this.polyline);this.polyline=null};ParaPara.FreehandLine.prototype.cancelLine=function(){console.assert(this.polyline,"Line already finished/cancelled?");this.polyline.parentNode.removeChild(this.polyline);this.polyline=null};ParaPara.FreehandLine.prototype.createPathFromPoints=function(a){if(a.numberOfItems==1){return this.createPoint(a)}var b=document.createElementNS(ParaPara.SVG_NS,"path");ParaPara.currentStyle.styleStroke(b);var g=ParaPara.fixPrecision;if(a.numberOfItems==2){var f=a.getItem(0);var e=a.getItem(1);var c="M"+[f.x,f.y].map(g).join(" ")+"L"+[e.x,e.y].map(g).join(" ");b.setAttribute("d",c)}else{a=this.prunePoints(a);var f=a[0];var c="M"+[f.x,f.y].map(g).join(" ")+"C"+this.smoothPoints(a).map(g).join(" ");b.setAttribute("d",c)}return b};ParaPara.FreehandLine.prototype.createPoint=function(a){console.assert(a.numberOfItems===1,"Expected only one point");var b=document.createElementNS(ParaPara.SVG_NS,"circle");b.setAttribute("r",ParaPara.currentStyle.strokeWidth/2);b.setAttribute("cx",a.getItem(0).x);b.setAttribute("cy",a.getItem(0).y);ParaPara.currentStyle.styleFill(b);return b};ParaPara.FreehandLine.prototype.prunePoints=function(e){var b=e.numberOfItems;var a=(b<20)?(b<10)?1:2:3;var c=[];for(var d=0;d<b-a;d+=a){var g=e.getItem(d);c.push({x:g.x,y:g.y})}var f=e.getItem(b-1);c.push({x:f.x,y:f.y});return c};ParaPara.FreehandLine.prototype.smoothPoints=function(k){var l=k[0];var a=[l.x,l.y];var h=k.length;for(var d=1;d<h;d++){var b=k[d-1];var o=k[d];var f=k[(d<h-1)?d+1:d];var e=Math.atan2(b.y-o.y,b.x-o.x);var c=Math.atan2(f.y-o.y,f.x-o.x);var m=(e+c)/2+Math.PI/2;var g=ParaPara.Geometry.lineLength(o.x,o.y,f.x,f.y)/3;if(e-c<0){m+=Math.PI}var j=Math.cos(m)*g;var n=Math.sin(m)*g;a[a.length]=o.x+j;a[a.length]=o.y+n;a[a.length]=o.x;a[a.length]=o.y;if(d<h-1){a[a.length]=o.x-j;a[a.length]=o.y-n}}return a};ParaPara.Style=function(){this.currentColor="black";this.strokeWidth=4;this._eraseWidth=4};ParaPara.Style.prototype.styleStroke=function(a){a.setAttribute("stroke",this.currentColor);a.setAttribute("stroke-width",this.strokeWidth);a.setAttribute("stroke-linecap","round");a.setAttribute("fill","none");a.setAttribute("pointer-events","none")};ParaPara.Style.prototype.styleFill=function(a){a.setAttribute("fill",this.currentColor);a.setAttribute("stroke","none");a.setAttribute("pointer-events","none")};ParaPara.Style.prototype.__defineSetter__("eraseWidth",function(a){this._eraseWidth=a;ParaPara.eraseControls.setBrushWidth(this._eraseWidth)});ParaPara.Style.prototype.__defineGetter__("eraseWidth",function(){return this._eraseWidth});ParaPara.FrameList=function(){this.currentFrame=null;this.scene=ParaPara.editContent;this.appendFrame()};ParaPara.FrameList.prototype.getCurrentFrame=function(){return this.currentFrame};ParaPara.FrameList.prototype.appendFrame=function(){this.selectFrame(this.getFrameCount()-1);var b=this.getPrevFrame();if(b){this.getOrMakeOldFrames().appendChild(b)}if(this.currentFrame){this.getOrMakePrevFrames().appendChild(this.currentFrame)}var a=document.createElementNS(ParaPara.SVG_NS,"g");a.setAttribute("class","frame");this.scene.appendChild(a);this.currentFrame=a};ParaPara.FrameList.prototype.selectFrame=function(c){if(c<0||c>=this.getFrameCount()||!this.currentFrame){return}var g=this.getCurrentIndex();if(c===g){return}if(c<g){var a=g-c;var b=this.getOrMakeNextFrames();b.insertBefore(this.currentFrame,b.firstChild);this.currentFrame=null;if(a>1){b.insertBefore(this.getPrevFrame(),b.firstChild)}else{var h=this.getPrevFrame();this.scene.insertBefore(h,this.getNextFrames());this.currentFrame=h}var e=this.getOldFrames();var d=this.getPrevFrames();while(a>0){if(!e||e.childNodes.length===0){break}var f=this.getOldFrames().lastChild;switch(a){case 1:d.appendChild(f);break;case 2:this.scene.insertBefore(f,b);this.currentFrame=f;break;default:b.insertBefore(f,b.firstChild);break}a--}if(e&&!e.hasChildNodes()){e.parentNode.removeChild(e)}if(d&&!d.hasChildNodes()){d.parentNode.removeChild(d)}}else{var a=c-g;var h=this.getPrevFrame();if(h){this.getOrMakeOldFrames().appendChild(h)}if(a>1){this.getOrMakeOldFrames().appendChild(this.currentFrame)}else{this.getOrMakePrevFrames().appendChild(this.currentFrame)}var b=this.getNextFrames();while(a>0){if(!b||b.childNodes.length===0){break}var f=this.getNextFrames().firstChild;switch(a){case 1:this.scene.insertBefore(f,b);this.currentFrame=f;break;case 2:this.getOrMakePrevFrames().appendChild(f);break;default:this.getOrMakeOldFrames().appendChild(f);break}a--}if(b&&!b.hasChildNodes()){b.parentNode.removeChild(b)}}};ParaPara.FrameList.prototype.deleteFrame=function(b){if(b<0||b>=this.getFrameCount()||!this.currentFrame){return}var c=this.getCurrentIndex();this.selectFrame(0);if(b===0){this.currentFrame.parentNode.removeChild(this.currentFrame);this.currentFrame=null;var a=this.getNextFrames();if(!a){this.appendFrame()}else{var d=a.firstChild;this.scene.insertBefore(d,a);this.currentFrame=d}}else{var a=this.getNextFrames();a.removeChild(a.childNodes[b-1])}var a=this.getNextFrames();if(a&&!a.hasChildNodes()){a.parentNode.removeChild(a)}this.selectFrame(Math.min(c,this.getFrameCount()-1))};ParaPara.FrameList.prototype.getFrames=function(){return this.scene.getElementsByClassName("frame")};ParaPara.FrameList.prototype.getCurrentIndex=function(){return this.getOldFrames()?this.getOldFrames().childNodes.length+1:this.getPrevFrame()?1:0};ParaPara.FrameList.prototype.getFrameCount=function(){return this.getFrames().length};ParaPara.FrameList.prototype.getPrevFrame=function(){var a=this.getPrevFrames();return a?a.lastChild:null};ParaPara.FrameList.prototype.getPrevFrames=function(){return this._getPrevFrames(false)};ParaPara.FrameList.prototype.getOrMakePrevFrames=function(){return this._getPrevFrames(true)};ParaPara.FrameList.prototype._getPrevFrames=function(a){return this._getOrMakeGroup(this.scene,true,"prevFrames",a)};ParaPara.FrameList.prototype.getOldFrames=function(){var a=this.getPrevFrames();if(!a){return null}return this._getOrMakeGroup(a,true,"oldFrames",false)};ParaPara.FrameList.prototype.getOrMakeOldFrames=function(){var a=this.getOrMakePrevFrames();return this._getOrMakeGroup(a,true,"oldFrames",true)};ParaPara.FrameList.prototype.getNextFrames=function(){return this._getNextFrames(false)};ParaPara.FrameList.prototype.getOrMakeNextFrames=function(){return this._getNextFrames(true)};ParaPara.FrameList.prototype._getNextFrames=function(a){return this._getOrMakeGroup(this.scene,false,"nextFrames",a)};ParaPara.FrameList.prototype._getOrMakeGroup=function(d,f,c,a){var b=f?d.firstChild:d.lastChild;if(b&&b.classList.contains(c)){return b}if(!a){return null}var e=document.createElementNS(ParaPara.SVG_NS,"g");e.setAttribute("class",c);return d.insertBefore(e,f?d.firstChild:null)};ParaPara.Animator=function(b,a){this.dur=1/b;this.animation=document.createElementNS(ParaPara.SVG_NS,"g");a.appendChild(this.animation)};ParaPara.Animator.prototype.makeAnimation=function(){var f=ParaPara.frames.getFrames();var e="";for(var a=0;a<f.length;++a){var d=f[a];if(!d.hasChildNodes()){continue}this.animation.appendChild(d.cloneNode(true))}f=this.animation.childNodes;if(f.length<2){return}for(var a=0;a<f.length;++a){var d=f[a];d.removeAttribute("class");d.setAttribute("visibility","hidden");var b=document.createElementNS(ParaPara.SVG_NS,"set");b.setAttribute("attributeName","visibility");b.setAttribute("to","visible");b.setAttribute("dur",this.dur+"s");var g="anim"+ParaPara.Utils.uuid();b.setAttribute("id",g);if(e){b.setAttribute("begin",e+".end")}d.appendChild(b);e=g}var c=f[0].getElementsByTagName("set")[0];c.setAttribute("begin","0; "+e+".end");ParaPara.svgRoot.setCurrentTime(0)};ParaPara.Animator.prototype.removeAnimation=function(){if(this.animation&&this.animation.parentNode){this.animation.parentNode.removeChild(this.animation)}this.animation=null};ParaPara.Animator.prototype.exportAnimation=function(o,g){var p=document.implementation.createDocument(ParaPara.SVG_NS,"svg",null);var k=p.documentElement;k.setAttribute("width","100%");k.setAttribute("height","100%");k.pauseAnimations();if(o){var f=p.createElementNS(ParaPara.SVG_NS,"title");f.appendChild(p.createTextNode(o));k.appendChild(f)}if(g){var c=p.createElementNS(ParaPara.SVG_NS,"desc");var m=g+"さんより";c.appendChild(p.createTextNode(m));k.appendChild(c)}var e=minY=Number.POSITIVE_INFINITY;var a=maxY=Number.NEGATIVE_INFINITY;var n=this.animation.childNodes;if(!n.length){return null}for(var j=0;j<n.length;++j){var d=n[j];console.assert(d.childNodes.length,"Empty frames should have already been dropped");var q=this.getDecoratedBbox(d);e=Math.floor(Math.min(e,q.x));a=Math.ceil(Math.max(a,q.x+q.width));minY=Math.floor(Math.min(minY,q.y));maxY=Math.ceil(Math.max(maxY,q.y+q.height));var b=p.importNode(d,true);b.removeAttribute("style");k.appendChild(b)}var h=ParaPara.svgRoot.getAttribute("viewBox");console.assert(h,"No parent viewBox");h=h.trim().split(" ").map(parseFloat);e=Math.max(e,h[0]);a=Math.min(a,h[0]+h[2]);minY=Math.max(minY,h[1]);maxY=Math.min(maxY,h[1]+h[3]);k.setAttribute("viewBox",[e,minY,a-e,maxY-minY].join(" "));var l=(h[3]-maxY)/(h[3]-h[1]);k.setAttribute("data-ground-offset",l.toFixed(3));return{doc:p,groundOffset:l,width:a-e,height:maxY-minY}};ParaPara.Animator.prototype.getDecoratedBbox=function(e){var d=e.getBBox();var c=0;var b=e.querySelectorAll("path");for(var a=0;a<b.length;a++){var f=parseInt(window.getComputedStyle(b[a]).strokeWidth);c=Math.max(c,f)}d.x-=c/2;d.y-=c/2;d.width+=c;d.height+=c;return d};ParaPara.Animator.prototype.setSpeed=function(d){this.dur=1/d;var a=this.animation.getElementsByTagName("set");for(var b=0;b<a.length;++b){var c=a[b];c.setAttribute("dur",this.dur+"s")}};ParaPara.Utils={};ParaPara.Utils.uuid=function(){return UUID.generate().replace(/-/g,"")};var ParaPara=ParaPara||{};ParaPara.SVG_NS=ParaPara.SVG_NS||"http://www.w3.org/2000/svg";ParaPara.XLINK_NS=ParaPara.XLINK_NS||"http://www.w3.org/1999/xlink";if(typeof ParaPara.fixPrecision!=="function"){ParaPara.fixPrecision=function(a){return a.toFixed(2)}}ParaPara.EraseControls=function(){this.eraser=null;this.currentTouch=null;this.frame=null;this.brushWidth=undefined;this.prevX=undefined;this.prevY=undefined;this.mouseDownHandler=this.mouseDown.bind(this);this.mouseMoveHandler=this.mouseMove.bind(this);this.mouseUpHandler=this.mouseUp.bind(this);this.touchStartHandler=this.touchStart.bind(this);this.touchMoveHandler=this.touchMove.bind(this);this.touchEndHandler=this.touchEnd.bind(this);this.touchCancelHandler=this.touchEnd.bind(this);if(ParaPara.erasePrecision===undefined){ParaPara.erasePrecision=1}};ParaPara.EraseControls.prototype.targetFrame=function(a){console.assert(!this.eraser,"Already erasing?");this.frame=a;this.brushWidth=10;ParaPara.svgRoot.addEventListener("mousedown",this.mouseDownHandler);ParaPara.svgRoot.addEventListener("mousemove",this.mouseMoveHandler);ParaPara.svgRoot.addEventListener("mouseup",this.mouseUpHandler);ParaPara.svgRoot.addEventListener("touchstart",this.touchStartHandler);ParaPara.svgRoot.addEventListener("touchmove",this.touchMoveHandler);ParaPara.svgRoot.addEventListener("touchend",this.touchEndHandler);ParaPara.svgRoot.addEventListener("touchcancel",this.touchCancelHandler);this.prevX=undefined;this.prevY=undefined};ParaPara.EraseControls.prototype.disable=function(){ParaPara.svgRoot.removeEventListener("mousedown",this.mouseDownHandler);ParaPara.svgRoot.removeEventListener("mousemove",this.mouseMoveHandler);ParaPara.svgRoot.removeEventListener("mouseup",this.mouseUpHandler);ParaPara.svgRoot.removeEventListener("touchstart",this.touchStartHandler);ParaPara.svgRoot.removeEventListener("touchmove",this.touchMoveHandler);ParaPara.svgRoot.removeEventListener("touchend",this.touchEndHandler);ParaPara.svgRoot.removeEventListener("touchcancel",this.touchCancelHandler)};ParaPara.EraseControls.prototype.setBrushWidth=function(a){this.brushWidth=a};ParaPara.EraseControls.prototype.mouseDown=function(a){a.preventDefault();if(this.eraser){return}this.eraser=new ParaPara.Eraser(this.frame,this.brushWidth);this.eraseFromEvent(a)};ParaPara.EraseControls.prototype.mouseMove=function(a){a.preventDefault();if(!this.eraser){return}this.eraseFromEvent(a)};ParaPara.EraseControls.prototype.mouseUp=function(a){a.preventDefault();if(!this.eraser){return}this.eraser=null;this.prevX=this.prevY=undefined;ParaPara.notifyGraphicChanged()};ParaPara.EraseControls.prototype.touchStart=function(a){a.preventDefault();if(this.eraser){return}this.currentTouch=a.changedTouches[0].identifier;this.eraser=new ParaPara.Eraser(this.frame,this.brushWidth);this.eraseFromEvent(a)};ParaPara.EraseControls.prototype.touchMove=function(a){a.preventDefault();if(!this.eraser){return}this.eraseFromEvent(a)};ParaPara.EraseControls.prototype.touchEnd=function(a){a.preventDefault();if(!this.eraser){return}for(var b=0;b<a.changedTouches.length;++b){var c=a.changedTouches[b];if(c.identifier==this.currentTouch){this.currentTouch=null;break}}if(this.currentTouch){return}this.eraser=null;this.prevX=this.prevY=undefined;ParaPara.notifyGraphicChanged()};ParaPara.EraseControls.prototype.eraseFromEvent=function(a){console.assert(this.eraser,"No eraser to use");var e=this.getCoordsFromEvent(a);if(!e){return}var c=[];var f=this.getLocalCoords(e[0],e[1],this.frame);c=this.getCandidateShapes(f.x,f.y);var d=[];for(var b=0;b<c.length;b++){d.push(c[b].id)}this.eraser.erase(f.x,f.y,c);this.prevX=f.x;this.prevY=f.y};ParaPara.EraseControls.prototype.getCoordsFromEvent=function(a){if(!a.changedTouches){return[a.clientX,a.clientY]}else{for(var b=0;b<a.changedTouches.length;++b){var c=a.changedTouches[b];if(c.identifier==this.currentTouch){return[c.clientX,c.clientY]}}}return null};ParaPara.EraseControls.prototype.getCandidateShapes=function(a,h){var b=this.frame.childNodes;var g=[];for(var d=b.length-1;d>=0;--d){var c=b[d];if(c.nodeType!=Node.ELEMENT_NODE){continue}var f=c.getBBox();f.x-=this.brushWidth/2;f.y-=this.brushWidth/2;f.width+=this.brushWidth;f.height+=this.brushWidth;var e=this.prevX?ParaPara.Geometry.lineIntersectsRect([this.prevX,this.prevY,a,h],f):ParaPara.Geometry.rectContainsPoint(f,[a,h]);if(e){g.push(c)}}return g};ParaPara.EraseControls.prototype.getLocalCoords=function(a,e,b){var d=ParaPara.svgRoot.createSVGPoint();d.x=a;d.y=e;var c=b.parentNode.getScreenCTM();return d.matrixTransform(c.inverse())};ParaPara.Eraser=function(b,a){this.prevX=undefined;this.prevY=undefined;this.brushWidth=a;this.currentScale=b.getScreenCTM().a};ParaPara.Eraser.prototype.erase=function(k,g,c){var f=new ParaPara.Brush(this.prevX?[this.prevX,this.prevY,k,g]:[k,g]);var h=this.brushWidth/this.currentScale;var d=c.length;for(var b=0;b<d;++b){var e=c[b];if(e.tagName=="path"){var j=parseFloat(window.getComputedStyle(e,null).getPropertyValue("stroke-width",null));var a=h+j;f.setWidth(a);this.cutPath(f,e)}else{if(e.tagName=="circle"){this.cutCircle(f,e)}else{console.assert(false,"Got unexpected shape type: "+e.tagName)}}}this.prevX=k;this.prevY=g};ParaPara.Eraser.prototype.cutPath=function(k,m){var b=m.pathSegList;var l=undefined;var c=false;var a=new Array();for(var g=0;g<b.numberOfItems;++g){var f=b.getItem(g);var e=this.getSegObject(f,l);var h=e.cut(k);if(h!=e){c=true}a=a.concat(h);l={x:f.x,y:f.y}}if(c){a=a.filter(ParaPara.Eraser.filterSuperfluousMoveTo);if(!a.length){m.parentNode.removeChild(m)}else{var j=a.join("");m.setAttribute("d",j)}}return c};ParaPara.Eraser.filterSuperfluousMoveTo=function(b,a,c){if(b.constructor!=ParaPara.MoveToSegment){return true}return a<c.length-1&&c[a+1].constructor!=ParaPara.MoveToSegment};ParaPara.Eraser.prototype.getSegObject=function(a,b){switch(a.pathSegType){case SVGPathSeg.PATHSEG_MOVETO_ABS:return new ParaPara.MoveToSegment([a.x,a.y]);case SVGPathSeg.PATHSEG_LINETO_ABS:return new ParaPara.LineToSegment([b.x,b.y,a.x,a.y]);case SVGPathSeg.PATHSEG_CURVETO_CUBIC_ABS:return new ParaPara.CurveToSegment([b.x,b.y,a.x1,a.y1,a.x2,a.y2,a.x,a.y]);default:console.assert(false,"Unexpected path segment type: "+a.pathSegType);break}};ParaPara.Eraser.prototype.cutCircle=function(a,b){b.parentNode.removeChild(b)};ParaPara.Brush=function(a){console.assert(a instanceof Array&&a.length==2||a.length==4,"Unexpected brush dimensions");this.points=a;this.bbox=null;this.width=undefined;this.length=undefined;this.path=[];this.mx=null;this.angle=this.points.length==2?0:Math.atan2(this.points[3]-this.points[1],this.points[2]-this.points[0])};ParaPara.Brush.prototype.setWidth=function(c){if(this.width==c){return}this.width=c;if(this.points.length==2){var b=this.width/Math.SQRT2/2;this.path=[this.points[0]-b,this.points[1]-b,this.points[0]+b,this.points[1]-b,this.points[0]+b,this.points[1]+b,this.points[0]-b,this.points[1]+b];this.length=b*2}else{var e=Math.cos(this.angle-Math.PI/2)*this.width/2;var a=Math.sin(this.angle-Math.PI/2)*this.width/2;var d=Math.cos(this.angle)*this.width/2;var f=Math.sin(this.angle)*this.width/2;this.path=[];this.path.push(this.points[0]+e-d);this.path.push(this.points[1]+a-f);this.path.push(this.points[0]-e-d);this.path.push(this.points[1]-a-f);this.path.push(this.points[2]-e+d);this.path.push(this.points[3]-a+f);this.path.push(this.points[2]+e+d);this.path.push(this.points[3]+a+f);this.length=ParaPara.Geometry.lineLength(this.points[0],this.points[1],this.points[2],this.points[3])+this.width}this.bbox=null};ParaPara.Brush.prototype.getDimensions=function(a){if(this.points.length==2){return{width:this.length,length:this.length}}else{return{width:this.width,length:this.length}}};ParaPara.Brush.prototype.getBBox=function(b){if(this.bbox){return this.bbox}var a=Math.min(this.path[0],this.path[2],this.path[4],this.path[6]);var e=Math.min(this.path[1],this.path[3],this.path[5],this.path[7]);var d=Math.max(this.path[0],this.path[2],this.path[4],this.path[6]);var c=Math.max(this.path[1],this.path[3],this.path[5],this.path[7]);this.bbox={x:a,y:e,width:d-a,height:c-e};return this.bbox};ParaPara.Brush.prototype.getTransform=function(){if(this.mx){return this.mx}if(this.points.length==2){this.mx=ParaPara.svgRoot.createSVGMatrix();this.mx=this.mx.translate(-this.path[0],-this.path[1])}else{var a=this.angle*180/Math.PI;this.mx=ParaPara.svgRoot.createSVGMatrix();this.mx=this.mx.rotate(-a,0,0);this.mx=this.mx.translate(-this.path[0],-this.path[1])}return this.mx};ParaPara.Brush.prototype.transformPoint=function(a){var d=this.getTransform();if(!d){return a.slice()}var c=d.a*a[0]+d.c*a[1]+d.e;var b=d.b*a[0]+d.d*a[1]+d.f;return[c,b]};ParaPara.Brush.prototype.transformPoints=function(d){var e=this.getTransform();if(!e){return d.slice()}var b=[];for(var c=0;c<d.length;c+=2){var a=this.transformPoint(d.slice(c,c+2));b.push(a[0],a[1])}return b};ParaPara.Geometry={};ParaPara.Geometry.linesIntersect=function(n,m){var c=n[0];var k=n[1];var b=n[2];var i=n[3];var a=m[0];var h=m[1];var o=m[2];var g=m[3];var f=(c*i-k*b)*(a-o)-(c-b)*(a*g-h*o);var e=(c*i-k*b)*(h-g)-(k-i)*(a*g-h*o);var d=(c-b)*(h-g)-(k-i)*(a-o);if(d==0){return null}var l=f/d;var j=e/d;return[l,j]};ParaPara.Geometry.segmentsIntersect=function(b,a){var d=ParaPara.Geometry.isBetween;var c=ParaPara.Geometry.linesIntersect(b,a);return c&&d(c[0],b[0],b[2])&&d(c[0],a[0],a[2])&&d(c[1],b[1],b[3])&&d(c[1],a[1],a[3])?c:null};ParaPara.Geometry.lineIntersectsRect=function(b,d){var e=[d.x,d.y,d.x+d.width,d.y,d.x+d.width,d.y+d.height,d.x,d.y+d.height];if((b[0]>=e[0]&&b[0]<=e[4]&&b[1]>=e[1]&&b[1]<=e[5])||(b[2]>=e[0]&&b[2]<=e[4]&&b[3]>=e[1]&&b[3]<=e[5])){return true}for(var c=0;c<4;++c){var a=c<3?e.slice(c*2,c*2+4):e.slice(c*2,c*2+2).concat(e.slice(0,2));if(ParaPara.Geometry.segmentsIntersect(b,a)){return true}}return false};ParaPara.Geometry.intersectsWithZeroedRect=function(p,d,o){var n=[];var f=(p[3]-p[1])/(p[2]-p[0]);var g,c,e,a;if(p[0]<p[2]){g=Math.max(0,p[0]);c=Math.min(d,p[2])}else{g=Math.max(0,p[2]);c=Math.min(d,p[0])}if(g>=c){return n}if(p[1]<p[3]){e=Math.max(0,p[1]);a=Math.min(o,p[3])}else{e=Math.max(0,p[3]);a=Math.min(o,p[1])}if(e>=a){return n}var b=[0,d];for(var h=0;f!=Infinity&&h<b.length;++h){var l=b[h];var j=f*(l-p[0])+p[1];if(l>=g&&l<=c&&j>=e&&j<=a){n.push([l,j])}}var k=[0,o];for(var h=0;f!=0&&h<k.length;++h){var j=k[h];var l=1/f*(j-p[1])+p[0];if(l>=g&&l<=c&&j>=e&&j<=a){n.push([l,j])}}return n};ParaPara.Geometry.rectsIntersect=function(b,a){return !(b.x+b.width<=a.x||b.x>=a.x+a.width||b.y+b.height<=a.y||b.y>=a.y+a.height)};ParaPara.Geometry.rectContainsRect=function(b,a){return a.x>=b.x&&a.x+a.width<=b.x+b.width&&a.y>=b.y&&a.y+a.height<=b.y+b.height};ParaPara.Geometry.rectContainsLine=function(c,a){var b=ParaPara.Geometry.rectContainsPoint;return b(c,[a[0],a[1]])&&b(c,[a[2],a[3]])};ParaPara.Geometry.rectContainsPoint=function(b,a){return b.x<=a[0]&&a[0]<=b.x+b.width&&b.y<=a[1]&&a[1]<=b.y+b.height};ParaPara.Geometry.lineLength=function(b,d,a,c){return Math.sqrt((a-=b)*a+(c-=d)*c)};ParaPara.Geometry.isBetween=function(d,e,c){var f=0.000001;return d>=Math.min(e,c)-f&&d<=Math.max(e,c)+f};ParaPara.Geometry.prettyMuchEqual=function(d,c){var e=0.000001;return Math.abs(d-c)<e};ParaPara.MoveToSegment=function(a){console.assert(a instanceof Array&&a.length==2,"Unexpected segment length");this.point=a};ParaPara.MoveToSegment.prototype.cut=function(a){return this};ParaPara.MoveToSegment.prototype.toString=function(){return"M"+this.point.map(ParaPara.fixPrecision).join(" ")};ParaPara.LineToSegment=function(a){console.assert(a instanceof Array&&a.length==4,"Unexpected segment length");this.points=a};ParaPara.LineToSegment.prototype.cut=function(d){var c=ParaPara.MoveToSegment;var k=ParaPara.LineToSegment;var j=ParaPara.Geometry.prettyMuchEqual;var h=d.getBBox();if(!ParaPara.Geometry.lineIntersectsRect(this.points,h)){return this}var g=d.transformPoints(this.points);var e=d.getDimensions();var q={x:0,y:0,width:e.length,height:e.width};if(ParaPara.Geometry.rectContainsLine(q,g)){return new c(this.points.slice(2))}var u=[];for(var o=0;o<4;++o){var l=o<3?d.path.slice(o*2,o*2+4):d.path.slice(o*2,o*2+2).concat(d.path.slice(0,2));var m=ParaPara.Geometry.segmentsIntersect(this.points,l);if(m){if(u.length&&j(m[0],u[u.length-2])&&j(m[1],u[u.length-1])){continue}u.push(m[0],m[1]);if(u.length==4){break}}}if(!u.length){return this}if(u.length==4){var t,s;if(this.points[2]==this.points[0]){t=3;s=1}else{t=2;s=0}if((this.points[t]-this.points[s]<0)!=(u[t]-u[s]<0)){var r=u.slice(0,2);u[0]=u[2];u[1]=u[3];u[2]=r[0];u[3]=r[1]}}var p=g[0]>=0&&g[0]<=e.length&&g[1]>=0&&g[1]<=e.width;var f=[];var n=this.points.slice(0,2).concat(u,this.points.slice(2));for(var o=0;o<n.length-2;o+=2){if(p){f.push(new c(n.slice(o+2,o+4)))}else{f.push(new k(n.slice(o,o+4)))}p=!p}return f};ParaPara.LineToSegment.prototype.toString=function(){return"L"+this.points.slice(2).map(ParaPara.fixPrecision).join(" ")};ParaPara.CurveToSegment=function(a){console.assert(a instanceof Array&&a.length==8,"Unexpected segment length");this.points=a};ParaPara.CurveToSegment.prototype.cut=function(c){var a=ParaPara.MoveToSegment;var A=ParaPara.CurveToSegment;var y=ParaPara.Geometry.lineLength;var d=ParaPara.Geometry.segmentsIntersect;var n=c.getBBox();var F=this.getBBox();if(!ParaPara.Geometry.rectsIntersect(n,F)){return this}var e=new A(c.transformPoints(this.points));var f=c.getDimensions();var E={x:0,y:0,width:f.length,height:f.width};var x=y(this.points[0],this.points[1],this.points[6],this.points[7]);if(x<c.width*0.75){var l=[e.points[0],e.points[1],e.points[6],e.points[7]];return ParaPara.Geometry.intersectsWithZeroedRect(l,E)?new a(this.points.slice(6)):this}var q=e.getBBox();if(ParaPara.Geometry.rectContainsRect(E,q)){return new a(this.points.slice(6))}if(!ParaPara.Geometry.rectsIntersect(q,E)){return this}var k=1/ParaPara.erasePrecision;var p=e.getValue(0);var G=[];var b=p[0]>=0&&p[0]<=f.length&&p[1]>=0&&p[1]<=f.width;for(var o=k;o<=1;o+=k){var B=e.getValue(o);var m=ParaPara.Geometry.intersectsWithZeroedRect([p[0],p[1],B[0],B[1]],f.length,f.width);if(m.length){var s=y(p[0],p[1],B[0],B[1]);for(var z=0;z<m.length;++z){var r=m[z];if(r[0]==p[0]&&r[1]==p[1]){continue}var j=y(p[0],p[1],r[0],r[1])/s;var w=o-k+k*j;G.push(w)}}p=B}if(!G.length&&!b){return this}G.sort(function(t,i){return t-i});var D=b;var h=[];var C=this.points;var v=0;for(var z=0;z<G.length;++z){var o=G[z];var g=(o-v)/(1-v);var u=this.splitSegment(C,g);if(D){h.push(new a(u[0].slice(6)))}else{h.push(new A(u[0]))}C=u[1];D=!D;v=o}if(D){h.push(new a(C.slice(6)))}else{h.push(new A(C))}return h};ParaPara.CurveToSegment.prototype.splitSegment=function(g,e){var h=[g[0],g[1]];var f=[g[6],g[7]];var d=g;var a=[];for(var c=3;c>=1;--c){a=[];for(var b=0;b<c;++b){a.push(d[b*2]*(1-e)+d[b*2+2]*e);a.push(d[b*2+1]*(1-e)+d[b*2+3]*e)}h.push(a[0],a[1]);f.unshift(a[(c-1)*2],a[(c-1)*2+1]);d=a}return[h,f]};ParaPara.CurveToSegment.prototype.getValue=function(a){return[this.getX(a),this.getY(a)]};ParaPara.CurveToSegment.prototype.getX=function(a){return this.computeCubicBaseValue(a,this.points[0],this.points[2],this.points[4],this.points[6])};ParaPara.CurveToSegment.prototype.getY=function(a){return this.computeCubicBaseValue(a,this.points[1],this.points[3],this.points[5],this.points[7])};ParaPara.CurveToSegment.prototype.computeCubicBaseValue=function(h,f,e,j,i){var g=1-h;return g*g*g*f+3*g*g*h*e+3*g*h*h*j+h*h*h*i};ParaPara.CurveToSegment.prototype.getBBox=function(){var a=Math.min(this.points[0],this.points[2],this.points[4],this.points[6]);var d=Math.min(this.points[1],this.points[3],this.points[5],this.points[7]);var c=Math.max(this.points[0],this.points[2],this.points[4],this.points[6]);var b=Math.max(this.points[1],this.points[3],this.points[5],this.points[7]);return{x:a,y:d,width:c-a,height:b-d}};ParaPara.CurveToSegment.prototype.toString=function(){return"C"+this.points.slice(2).map(ParaPara.fixPrecision).join(" ")}
/*! @source http://purl.eligrey.com/github/classList.js/blob/master/classList.js*/
;if(typeof document!=="undefined"&&!("classList" in document.createElement("a")&&"classList" in document.createElementNS("http://www.w3.org/2000/svg","g"))){(function(j){var a="http://www.w3.org/2000/svg",p="classList",n="prototype",r=Object,f=String[n].trim||function(){return this.replace(/^\s+|\s+$/g,"")},c=Array[n].indexOf||function(u){var t=0,s=this.length;for(;t<s;t++){if(t in this&&this[t]===u){return t}}return -1},i=function(s,t){this.name=s;this.code=DOMException[s];this.message=t},e=function(t,s){if(s===""){throw new i("SYNTAX_ERR","An invalid or illegal string was specified")}if(/\s/.test(s)){throw new i("INVALID_CHARACTER_ERR","String contains an invalid character")}return c.call(t,s)},d=function(x){var v=typeof x.className.baseVal!=="undefined"?x.className.baseVal:x.className,w=f.call(v),u=w?w.split(/\s+/):[],t=0,s=u.length;for(;t<s;t++){this.push(u[t])}this._updateClassName=function(){typeof x.className.baseVal!=="undefined"?x.className.baseVal=this.toString():x.className=this.toString()}},o=d[n]=[],m=function(){return new d(this)},q=function(s){if(r.defineProperty){var u={get:m,enumerable:true,configurable:true};try{r.defineProperty(s[n],p,u)}catch(t){if(t.number===-2146823252){u.enumerable=false;r.defineProperty(s[n],p,u)}}}else{if(r[n].__defineGetter__){elemCtrl[n].__defineGetter__(p,m)}}},k=function(t,s){if(!("classList" in t.createElement("a"))){q(s.HTMLElement||s.Element)}if(!("classList" in t.createElementNS(a,"g"))){q(s.SVGElement)}},g=function(s){if(s.contentDocument&&s.contentDocument.readyState=="complete"){var t=s.contentWindow||s.contentDocument.defaultView;k(s.contentDocument,t)}},l=function(){var t=document.getElementsByTagName("object");for(var s=0;s<t.length;++s){g(t[s])}},b=function(){l();document.addEventListener("DOMNodeInserted",h,true)},h=function(s){g(s.srcElement);s.srcElement.addEventListener("load",l,true)};i[n]=Error[n];o.item=function(s){return this[s]||null};o.contains=function(s){s+="";return e(this,s)!==-1};o.add=function(s){s+="";if(e(this,s)===-1){this.push(s);this._updateClassName()}};o.remove=function(t){t+="";var s=e(this,t);if(s!==-1){this.splice(s,1);this._updateClassName()}};o.toggle=function(s){s+="";if(e(this,s)===-1){this.add(s)}else{this.remove(s)}};o.toString=function(){return this.join(" ")};k(document,j);if(document.readyState!="complete"){document.addEventListener("DOMContentLoaded",b,true);window.addEventListener("load",l,true)}else{b()}}(self))}var ParaPara=ParaPara||{};ParaPara.XHR_TIMEOUT=8000;ParaPara.postRequest=function(b,g,a,h){var c=JSON.stringify(g);var d=new XMLHttpRequest();d.open("POST",b,true);d.setRequestHeader("Content-Type","application/json");d.onreadystatechange=function(){if(d.readyState!=4){return}if(d.status==200||d.status==0){try{var i=JSON.parse(d.responseText);if(i.error_key){h(i.error_key,i.error_detail)}else{a(JSON.parse(d.responseText))}}catch(j){if(j instanceof SyntaxError){console.debug("Error sending to server, could not parse response: "+d.responseText);h("server-fail")}else{throw j}}}else{h("no-access")}};try{d.send(c)}catch(f){console.debug(f);h("send-fail");return}window.setTimeout(function(){if(d.readyState!=4){d.abort();h("timeout")}},ParaPara.XHR_TIMEOUT)};if(!Function.prototype.bind){Function.prototype.bind=function(a){if(typeof this!=="function"){throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable")}var e=Array.prototype.slice.call(arguments,1),d=this,b=function(){},c=function(){return d.apply(this instanceof b?this:a||window,e.concat(Array.prototype.slice.call(arguments)))};b.prototype=this.prototype;c.prototype=new b();return c}}function UUID(){}UUID.generate=function(){var a=UUID._gri,b=UUID._ha;return b(a(32),8)+"-"+b(a(16),4)+"-"+b(16384|a(12),4)+"-"+b(32768|a(14),4)+"-"+b(a(48),12)};UUID._gri=function(a){if(a<0){return NaN}if(a<=30){return(0|Math.random()*(1<<a))}if(a<=53){return(0|Math.random()*(1<<30))+(0|Math.random()*(1<<a-30))*(1<<30)}return NaN};UUID._ha=function(a,c){var e=a.toString(16),b=c-e.length,d="0";for(;b>0;b>>>=1,d+=d){if(b&1){e=d+e}}return e};